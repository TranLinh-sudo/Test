-- Dịch vụ cần thiết
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local VirtualUser = game:GetService("VirtualUser")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualInputManager = game:GetService("VirtualInputManager")
local LocalPlayer = Players.LocalPlayer

-- --- CÀI ĐẶT CHUNG ---
_G.Settings = {
	WeaponMode = "Melee", -- Melee, Sword, Fruit
	AutoFarmLevel = false,
	AutoFarmNear = false,
	AutoBone = false,
	AutoTradeBone = false,
	AutoSoulReaper = false,
	Distance = 20, -- Giữ nguyên 20m theo ý bạn
	AutoHaki = true
}

-- Hàm bảo vệ UI
local function getParent()
	local success, result = pcall(function() return CoreGui end)
	if success then return result else return LocalPlayer:WaitForChild("PlayerGui") end
end

local Colors = {
	Background = Color3.fromRGB(20, 20, 20),
	Sidebar = Color3.fromRGB(15, 15, 15),
	ItemBG = Color3.fromRGB(35, 35, 35),
	Text = Color3.fromRGB(255, 255, 255),
	Accent = Color3.fromRGB(255, 215, 0),
	Header = Color3.fromRGB(0, 255, 255),
	Close = Color3.fromRGB(200, 50, 50),
	ToggleOn = Color3.fromRGB(0, 200, 100),
	ToggleOff = Color3.fromRGB(60, 60, 60)
}

-- --- TẠO GUI ---
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "BananaCatHub_AttackFix_V2"
ScreenGui.Parent = getParent()
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- 1. ICON (KÉO THẢ ĐƯỢC)
local OpenButton = Instance.new("ImageButton")
OpenButton.Parent = ScreenGui
OpenButton.BackgroundColor3 = Colors.Background
OpenButton.Position = UDim2.new(0.02, 0, 0.15, 0)
OpenButton.Size = UDim2.new(0, 50, 0, 50)
OpenButton.Image = "rbxassetid://13693489228"
OpenButton.ZIndex = 10
Instance.new("UICorner", OpenButton).CornerRadius = UDim.new(1, 0)
Instance.new("UIStroke", OpenButton).Color = Colors.Accent

-- 2. MAIN FRAME
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Colors.Background
MainFrame.BackgroundTransparency = 0.1
MainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
MainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
MainFrame.Size = UDim2.new(0.75, 0, 0.75, 0) 
MainFrame.ClipsDescendants = true 
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 10)

OpenButton.MouseButton1Click:Connect(function() MainFrame.Visible = not MainFrame.Visible end)

-- 3. TOP BAR
local TopBar = Instance.new("Frame")
TopBar.Parent = MainFrame
TopBar.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
TopBar.BackgroundTransparency = 1
TopBar.Size = UDim2.new(1, 0, 0, 40)
TopBar.ZIndex = 2

local HeaderTitle = Instance.new("TextLabel")
HeaderTitle.Parent = TopBar
HeaderTitle.BackgroundTransparency = 1
HeaderTitle.Position = UDim2.new(0, 15, 0, 0)
HeaderTitle.Size = UDim2.new(0.6, 0, 1, 0)
HeaderTitle.Font = Enum.Font.GothamBold
HeaderTitle.Text = "Banana Cat Hub - Fix Attack"
HeaderTitle.TextColor3 = Colors.Accent
HeaderTitle.TextSize = 18
HeaderTitle.TextXAlignment = Enum.TextXAlignment.Left

local CloseBtn = Instance.new("TextButton")
CloseBtn.Parent = TopBar
CloseBtn.BackgroundColor3 = Colors.Close
CloseBtn.Position = UDim2.new(1, -35, 0.5, -12)
CloseBtn.Size = UDim2.new(0, 24, 0, 24)
CloseBtn.Font = Enum.Font.GothamBold
CloseBtn.Text = "X"
CloseBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
Instance.new("UICorner", CloseBtn).CornerRadius = UDim.new(0, 6)
CloseBtn.MouseButton1Click:Connect(function() ScreenGui:Destroy() end)

local MinimizeBtn = Instance.new("TextButton")
MinimizeBtn.Parent = TopBar
MinimizeBtn.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
MinimizeBtn.Position = UDim2.new(1, -70, 0.5, -12)
MinimizeBtn.Size = UDim2.new(0, 24, 0, 24)
MinimizeBtn.Font = Enum.Font.GothamBold
MinimizeBtn.Text = "-"
MinimizeBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
Instance.new("UICorner", MinimizeBtn).CornerRadius = UDim.new(0, 6)
MinimizeBtn.MouseButton1Click:Connect(function() MainFrame.Visible = false end)

-- KÉO THẢ
local function MakeDraggable(obj)
	local dragging, dragStart, startPos
	obj.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
			dragging = true
			dragStart = input.Position
			startPos = obj.Position
		end
	end)
	obj.InputChanged:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
			if dragging then
				local delta = input.Position - dragStart
				obj.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
			end
		end
	end)
	obj.InputEnded:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then dragging = false end
	end)
end
MakeDraggable(OpenButton)
MakeDraggable(MainFrame)

-- LAYOUT
local Sidebar = Instance.new("Frame")
Sidebar.Parent = MainFrame
Sidebar.BackgroundColor3 = Colors.Sidebar
Sidebar.BackgroundTransparency = 0.5
Sidebar.Position = UDim2.new(0, 0, 0, 40)
Sidebar.Size = UDim2.new(0.25, 0, 1, -40)

local TabList = Instance.new("ScrollingFrame")
TabList.Parent = Sidebar
TabList.BackgroundTransparency = 1
TabList.Position = UDim2.new(0, 10, 0, 10)
TabList.Size = UDim2.new(1, -20, 1, -10)
TabList.AutomaticCanvasSize = Enum.AutomaticSize.Y
TabList.ScrollBarThickness = 2
Instance.new("UIListLayout", TabList).Padding = UDim.new(0, 5)

local ContentContainer = Instance.new("Frame")
ContentContainer.Parent = MainFrame
ContentContainer.BackgroundTransparency = 1
ContentContainer.Position = UDim2.new(0.25, 10, 0, 50)
ContentContainer.Size = UDim2.new(0.75, -20, 1, -60)

local Pages = {} 
local currentTab = nil
local TabNames = { "Trạng thái", "Fam", "Biển", "item", "trái & tập kích", "cửa hàng", "Di chuyển", "Tộc V4", "Núi lửa", "Đảo LEVI", "Đảo cáo", "PVP", "Cài đặt" }

local function CreateTab(name)
	local Page = Instance.new("ScrollingFrame")
	Page.Name = name
	Page.Parent = ContentContainer
	Page.BackgroundTransparency = 1
	Page.Size = UDim2.new(1, 0, 1, 0)
	Page.Visible = false
	Page.AutomaticCanvasSize = Enum.AutomaticSize.Y
	Page.ScrollBarThickness = 4
	Instance.new("UIListLayout", Page).Padding = UDim.new(0, 8)

	local TabBtn = Instance.new("TextButton")
	TabBtn.Parent = TabList
	TabBtn.BackgroundColor3 = Colors.Background
	TabBtn.Size = UDim2.new(1, -10, 0, 40)
	TabBtn.Font = Enum.Font.GothamBold
	TabBtn.Text = name
	TabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
	TabBtn.TextSize = 13
	Instance.new("UICorner", TabBtn).CornerRadius = UDim.new(0, 8)
	
	TabBtn.MouseButton1Click:Connect(function()
		for _,v in pairs(ContentContainer:GetChildren()) do v.Visible = false end
		for _,v in pairs(TabList:GetChildren()) do 
			if v:IsA("TextButton") then v.TextColor3 = Color3.fromRGB(150,150,150) end
		end
		Page.Visible = true
		TabBtn.TextColor3 = Colors.Accent
	end)

	if currentTab == nil then
		currentTab = Page
		Page.Visible = true
		TabBtn.TextColor3 = Colors.Accent
	end
	Pages[name] = Page
end
for _, name in ipairs(TabNames) do CreateTab(name) end

-- UI COMPONENTS
local function CreateHeader(tabName, text)
	local page = Pages[tabName]
	local Label = Instance.new("TextLabel")
	Label.Parent = page
	Label.Text = text 
	Label.Font = Enum.Font.GothamBlack
	Label.TextSize = 18
	Label.TextColor3 = Colors.Header
	Label.Size = UDim2.new(1, -10, 0, 40)
	Label.BackgroundTransparency = 1
end

local function CreateToggle(tabName, text, settingKey)
	local page = Pages[tabName]
	local Frame = Instance.new("Frame")
	Frame.Parent = page
	Frame.BackgroundColor3 = Colors.ItemBG
	Frame.BackgroundTransparency = 0.5
	Frame.Size = UDim2.new(1, -10, 0, 40)
	Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 6)

	local Lbl = Instance.new("TextLabel")
	Lbl.Parent = Frame
	Lbl.Text = text
	Lbl.TextColor3 = Colors.Text
	Lbl.Font = Enum.Font.GothamSemibold
	Lbl.TextSize = 13
	Lbl.Size = UDim2.new(0.7, 0, 1, 0)
	Lbl.Position = UDim2.new(0, 15, 0, 0)
	Lbl.TextXAlignment = Enum.TextXAlignment.Left
	Lbl.BackgroundTransparency = 1

	local ToggleBtn = Instance.new("TextButton")
	ToggleBtn.Parent = Frame
	ToggleBtn.Position = UDim2.new(1, -50, 0.5, -10)
	ToggleBtn.Size = UDim2.new(0, 20, 0, 20)
	ToggleBtn.BackgroundColor3 = Colors.ToggleOff
	ToggleBtn.Text = ""
	Instance.new("UICorner", ToggleBtn).CornerRadius = UDim.new(0, 4)

	ToggleBtn.MouseButton1Click:Connect(function()
		_G.Settings[settingKey] = not _G.Settings[settingKey]
		ToggleBtn.BackgroundColor3 = _G.Settings[settingKey] and Colors.ToggleOn or Colors.ToggleOff
	end)
end

local function CreateDropdown(tabName, title, options)
	local page = Pages[tabName]
	local Frame = Instance.new("Frame")
	Frame.Parent = page
	Frame.BackgroundColor3 = Colors.ItemBG
	Frame.BackgroundTransparency = 0.5
	Frame.Size = UDim2.new(1, -10, 0, 45)
	Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 6)
	Frame.ClipsDescendants = true
	local Title = Instance.new("TextLabel")
	Title.Parent = Frame
	Title.Text = title .. ": " .. options[1]
	Title.TextColor3 = Colors.Text
	Title.Font = Enum.Font.GothamBold
	Title.Size = UDim2.new(1, 0, 0, 45)
	Title.Position = UDim2.new(0, 15, 0, 0)
	Title.TextXAlignment = Enum.TextXAlignment.Left
	Title.BackgroundTransparency = 1
	local OpenBtn = Instance.new("TextButton")
	OpenBtn.Parent = Frame
	OpenBtn.Size = UDim2.new(1, 0, 0, 45)
	OpenBtn.BackgroundTransparency = 1
	OpenBtn.Text = ""
	local isOpen = false
	OpenBtn.MouseButton1Click:Connect(function()
		isOpen = not isOpen
		Frame.Size = isOpen and UDim2.new(1, -10, 0, 45 + (#options*30)) or UDim2.new(1, -10, 0, 45)
	end)
	for i, v in ipairs(options) do
		local Opt = Instance.new("TextButton")
		Opt.Parent = Frame
		Opt.Size = UDim2.new(1, -20, 0, 30)
		Opt.Position = UDim2.new(0, 10, 0, 45 + ((i-1)*30))
		Opt.BackgroundColor3 = Colors.Sidebar
		Opt.Text = v
		Opt.TextColor3 = Color3.fromRGB(200,200,200)
		Opt.MouseButton1Click:Connect(function()
			_G.Settings.WeaponMode = v
			Title.Text = title .. ": " .. v
			Frame.Size = UDim2.new(1, -10, 0, 45)
			isOpen = false
		end)
	end
end

local function CreateStatusItem(tabName, labelText, getValueFunc)
	local page = Pages[tabName]
	local Frame = Instance.new("Frame")
	Frame.Parent = page
	Frame.BackgroundColor3 = Colors.ItemBG
	Frame.BackgroundTransparency = 0.5
	Frame.Size = UDim2.new(1, -10, 0, 35)
	Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 6)
	local Lbl = Instance.new("TextLabel")
	Lbl.Parent = Frame
	Lbl.Text = labelText
	Lbl.TextColor3 = Colors.Text
	Lbl.Font = Enum.Font.GothamSemibold
	Lbl.Size = UDim2.new(0.4, 0, 1, 0)
	Lbl.Position = UDim2.new(0, 15, 0, 0)
	Lbl.TextXAlignment = Enum.TextXAlignment.Left
	Lbl.BackgroundTransparency = 1
	local Val = Instance.new("TextLabel")
	Val.Parent = Frame
	Val.Text = "..."
	Val.TextColor3 = Colors.Accent
	Val.Font = Enum.Font.GothamBold
	Val.Size = UDim2.new(0.6, -15, 1, 0)
	Val.Position = UDim2.new(0.4, 0, 0, 0)
	Val.TextXAlignment = Enum.TextXAlignment.Right
	Val.BackgroundTransparency = 1
	spawn(function()
		while Frame.Parent do
			local s, r = pcall(getValueFunc)
			if s then Val.Text = tostring(r) else Val.Text = "N/A" end
			wait(1)
		end
	end)
end

-- --- THIẾT LẬP NỘI DUNG ---
CreateStatusItem("Trạng thái", "Tên :", function() return LocalPlayer.DisplayName end)
CreateStatusItem("Trạng thái", "Tộc :", function() return LocalPlayer.Data.Race.Value end)
CreateStatusItem("Trạng thái", "Beli :", function() return LocalPlayer.Data.Beli.Value end)
CreateStatusItem("Trạng thái", "Điểm F :", function() return LocalPlayer.Data.Fragments.Value end)
CreateStatusItem("Trạng thái", "Time :", function() 
	local t = workspace.DistributedGameTime
	return string.format("%02d:%02d:%02d", math.floor(t/3600), math.floor((t%3600)/60), math.floor(t%60))
end)

CreateHeader("Fam", "FAM")
CreateDropdown("Fam", "Chế độ Fam", {"Melee", "Sword", "Fruit"})
CreateToggle("Fam", "Auto Farm Level (All Sea)", "AutoFarmLevel")
CreateToggle("Fam", "Auto Farm Quái Gần", "AutoFarmNear")

CreateHeader("Fam", "XƯƠNG")
CreateToggle("Fam", "Auto Fam Xương (20m Safe)", "AutoBone")
CreateToggle("Fam", "Auto Đổi Xương", "AutoTradeBone")
CreateToggle("Fam", "Auto Soul Reaper", "AutoSoulReaper")

-- --- [CORE ENGINE] LOGIC FIX LỖI ---

-- 1. [FIX] AUTO HAKI (Chạy ngay khi bật)
spawn(function()
	while true do
		wait(3)
		if _G.Settings.AutoHaki then
			pcall(function()
				if not LocalPlayer.Character:FindFirstChild("HasBuso") then
					ReplicatedStorage.Remotes.CommF_:InvokeServer("Buso")
				end
			end)
		end
	end
end)

-- 2. [FIX] AUTO EQUIP WEAPON (Cầm vũ khí chắc chắn)
local function EquipWeapon()
	pcall(function()
		local backpack = LocalPlayer.Backpack
		local char = LocalPlayer.Character
		local weaponName = _G.Settings.WeaponMode
		
		for _, tool in pairs(backpack:GetChildren()) do
			if tool:IsA("Tool") then
				if (weaponName == "Melee" and tool.ToolTip == "Melee") or
				   (weaponName == "Sword" and tool.ToolTip == "Sword") or
				   (weaponName == "Fruit" and tool.ToolTip == "Blox Fruit") then
					char.Humanoid:EquipTool(tool)
				end
			end
		end
	end)
end

-- 3. LOGIC DI CHUYỂN
local function LockPosition(targetCFrame)
	local char = LocalPlayer.Character
	if not char or not char:FindFirstChild("HumanoidRootPart") then return end
	local hrp = char.HumanoidRootPart
	
	-- Bay cách 20m
	hrp.CFrame = targetCFrame * CFrame.new(0, _G.Settings.Distance, 0)
	
	if not hrp:FindFirstChild("AntiFall") then
		local bv = Instance.new("BodyVelocity")
		bv.Name = "AntiFall"
		bv.Parent = hrp
		bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
		bv.Velocity = Vector3.new(0, 0, 0)
	end
	
	for _, part in pairs(char:GetChildren()) do
		if part:IsA("BasePart") then part.CanCollide = false end
	end
end

local function UnlockPosition()
	local char = LocalPlayer.Character
	if char and char:FindFirstChild("HumanoidRootPart") and char.HumanoidRootPart:FindFirstChild("AntiFall") then
		char.HumanoidRootPart.AntiFall:Destroy()
	end
end

local HauntedCastleMobs = {"Reborn Skeleton", "Living Zombie", "Demonic Soul", "Posessed Mummy"}
local function IsBoneMob(mobName)
	for _, name in pairs(HauntedCastleMobs) do if mobName == name then return true end end
	return false
end

-- FARM LOOP
spawn(function()
	while true do
		RunService.RenderStepped:Wait()
		
		if _G.Settings.AutoBone or _G.Settings.AutoFarmLevel or _G.Settings.AutoFarmNear then
			pcall(function()
				EquipWeapon() -- Luôn cầm vũ khí
				
				local target = nil
				local myPos = LocalPlayer.Character.HumanoidRootPart.Position
				
				-- Tìm mục tiêu
				for _, enemy in pairs(workspace.Enemies:GetChildren()) do
					if enemy:FindFirstChild("Humanoid") and enemy.Humanoid.Health > 0 then
						if _G.Settings.AutoBone and IsBoneMob(enemy.Name) then
							target = enemy; break
						elseif (_G.Settings.AutoFarmLevel or _G.Settings.AutoFarmNear) and (enemy.HumanoidRootPart.Position - myPos).Magnitude < 1000 then
							target = enemy; break
						end
					end
				end
				
				if target and target:FindFirstChild("HumanoidRootPart") then
					LockPosition(target.HumanoidRootPart.CFrame)
					
					-- Gom quái
					for _, sub in pairs(workspace.Enemies:GetChildren()) do
						if sub ~= target and sub:FindFirstChild("HumanoidRootPart") and (sub.HumanoidRootPart.Position - target.HumanoidRootPart.Position).Magnitude < 300 then
							if (_G.Settings.AutoBone and IsBoneMob(sub.Name)) or (_G.Settings.AutoFarmLevel) then
								sub.HumanoidRootPart.CFrame = target.HumanoidRootPart.CFrame
								sub.HumanoidRootPart.CanCollide = false
								sub.Humanoid.WalkSpeed = 0
							end
						end
					end
				end
			end)
		else
			UnlockPosition()
		end
	end
end)

-- 4. [FIX] LOGIC ĐÁNH MẠNH HƠN (REMOTE ATTACK)
spawn(function()
	while true do
		if _G.Settings.AutoBone or _G.Settings.AutoFarmLevel or _G.Settings.AutoFarmNear then
			pcall(function()
				-- 1. Click giả lập
				VirtualUser:CaptureController()
				VirtualUser:Button1Down(Vector2.new(1280, 672))
				
				-- 2. Activate Tool
				local char = LocalPlayer.Character
				if char then
					local tool = char:FindFirstChildOfClass("Tool")
					if tool then tool:Activate() end
				end
				
				-- 3. [MỚI] Gửi Remote Event đánh (Sửa lỗi đứng xa không đánh)
				ReplicatedStorage.Remotes.CommF_:InvokeServer("LocalClick")
			end)
		end
		RunService.Heartbeat:Wait()
	end
end)

-- Auto Trade
spawn(function()
	while true do
		wait(2)
		if _G.Settings.AutoTradeBone then
			pcall(function() game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer("Bones", "Buy", 1, 1) end)
		end
	end
end)
