-- Dịch vụ cần thiết
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local CoreGui = game:GetService("CoreGui")
local VirtualUser = game:GetService("VirtualUser")
local LocalPlayer = Players.LocalPlayer

-- --- CÀI ĐẶT CHUNG (SETTINGS) ---
_G.Settings = {
	WeaponMode = "Melee",
	AutoFarmLevel = false,
	AutoFarmNear = false,
	AutoBone = false,        -- Chức năng chính bạn cần
	AutoTradeBone = false,
	AutoSoulReaper = false,
	Distance = 20,           -- [QUAN TRỌNG] Cách quái 20m
	FastAttackDelay = 0.1    -- Tốc độ đánh
}

-- Danh sách quái tại Lâu đài bóng tối (Haunted Castle)
local HauntedCastleMobs = {
	"Reborn Skeleton",
	"Living Zombie",
	"Demonic Soul",
	"Posessed Mummy"
}

-- Hàm kiểm tra quái có thuộc Lâu đài bóng tối không
local function IsBoneMob(mobName)
	for _, name in pairs(HauntedCastleMobs) do
		if mobName == name then return true end
	end
	return false
end

-- Hàm bảo vệ UI
local function getParent()
	local success, result = pcall(function() return CoreGui end)
	if success then return result else return LocalPlayer:WaitForChild("PlayerGui") end
end

-- --- MÀU SẮC ---
local Colors = {
	Background = Color3.fromRGB(20, 20, 20),
	Sidebar = Color3.fromRGB(15, 15, 15),
	ItemBG = Color3.fromRGB(35, 35, 35),
	Text = Color3.fromRGB(255, 255, 255),
	Accent = Color3.fromRGB(255, 215, 0), -- Vàng
	SectionText = Color3.fromRGB(0, 255, 255), -- Xanh ngọc
	ToggleOn = Color3.fromRGB(0, 200, 100),
	ToggleOff = Color3.fromRGB(60, 60, 60)
}

-- --- TẠO GUI CHÍNH ---
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "BananaCatHub_BoneFarm"
ScreenGui.Parent = getParent()
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

-- ICON TOGGLE
local OpenButton = Instance.new("ImageButton")
OpenButton.Parent = ScreenGui
OpenButton.BackgroundColor3 = Colors.Background
OpenButton.Position = UDim2.new(0.02, 0, 0.15, 0)
OpenButton.Size = UDim2.new(0, 50, 0, 50)
OpenButton.Image = "rbxassetid://13693489228"
Instance.new("UICorner", OpenButton).CornerRadius = UDim.new(1, 0)
Instance.new("UIStroke", OpenButton).Color = Colors.Accent
OpenButton.MouseButton1Click:Connect(function() 
	if ScreenGui:FindFirstChild("MainFrame") then
		ScreenGui.MainFrame.Visible = not ScreenGui.MainFrame.Visible 
	end
end)

-- MAIN FRAME
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Colors.Background
MainFrame.BackgroundTransparency = 0.1
MainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
MainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
MainFrame.Size = UDim2.new(0.75, 0, 0.75, 0) 
MainFrame.ClipsDescendants = true 
Instance.new("UICorner", MainFrame).CornerRadius = UDim.new(0, 10)

-- LAYOUT & TAB SYSTEM (Giữ nguyên cấu trúc cũ)
local Sidebar = Instance.new("Frame")
Sidebar.Parent = MainFrame
Sidebar.BackgroundColor3 = Colors.Sidebar
Sidebar.BackgroundTransparency = 0.5
Sidebar.Position = UDim2.new(0, 0, 0, 0)
Sidebar.Size = UDim2.new(0.25, 0, 1, 0)

local TabList = Instance.new("ScrollingFrame")
TabList.Parent = Sidebar
TabList.BackgroundTransparency = 1
TabList.Position = UDim2.new(0, 10, 0, 50) -- Chừa chỗ cho Header
TabList.Size = UDim2.new(1, -20, 1, -50)
TabList.AutomaticCanvasSize = Enum.AutomaticSize.Y
TabList.ScrollBarThickness = 2
Instance.new("UIListLayout", TabList).Padding = UDim.new(0, 5)

local ContentContainer = Instance.new("Frame")
ContentContainer.Parent = MainFrame
ContentContainer.BackgroundTransparency = 1
ContentContainer.Position = UDim2.new(0.25, 10, 0, 50)
ContentContainer.Size = UDim2.new(0.75, -20, 1, -50)

-- Tiêu đề Sidebar
local SideTitle = Instance.new("TextLabel")
SideTitle.Parent = Sidebar
SideTitle.Text = "Banana Cat"
SideTitle.Font = Enum.Font.GothamBold
SideTitle.TextSize = 20
SideTitle.TextColor3 = Colors.Accent
SideTitle.Size = UDim2.new(1, 0, 0, 50)
SideTitle.BackgroundTransparency = 1

local Pages = {} 
local currentTab = nil
local TabNames = { "Trạng thái", "Fam", "Biển", "item", "trái & tập kích", "cửa hàng", "Di chuyển", "Tộc V4", "Núi lửa", "Đảo LEVI", "Đảo cáo", "PVP", "Cài đặt" }

-- HÀM TẠO TAB
local function CreateTab(name)
	local Page = Instance.new("ScrollingFrame")
	Page.Name = name
	Page.Parent = ContentContainer
	Page.BackgroundTransparency = 1
	Page.Size = UDim2.new(1, 0, 1, 0)
	Page.Visible = false
	Page.AutomaticCanvasSize = Enum.AutomaticSize.Y
	Page.ScrollBarThickness = 4
	Instance.new("UIListLayout", Page).Padding = UDim.new(0, 8)

	local TabBtn = Instance.new("TextButton")
	TabBtn.Parent = TabList
	TabBtn.BackgroundColor3 = Colors.Background
	TabBtn.Size = UDim2.new(1, -10, 0, 40)
	TabBtn.Font = Enum.Font.GothamBold
	TabBtn.Text = name
	TabBtn.TextColor3 = Color3.fromRGB(150, 150, 150)
	TabBtn.TextSize = 13
	Instance.new("UICorner", TabBtn).CornerRadius = UDim.new(0, 8)
	
	TabBtn.MouseButton1Click:Connect(function()
		for _,v in pairs(ContentContainer:GetChildren()) do v.Visible = false end
		for _,v in pairs(TabList:GetChildren()) do 
			if v:IsA("TextButton") then v.TextColor3 = Color3.fromRGB(150,150,150) end
		end
		Page.Visible = true
		TabBtn.TextColor3 = Colors.Accent
	end)

	if currentTab == nil then
		currentTab = Page
		Page.Visible = true
		TabBtn.TextColor3 = Colors.Accent
	end
	Pages[name] = Page
end

for _, name in ipairs(TabNames) do CreateTab(name) end

-- --- CÁC HÀM UI ---

local function CreateSection(tabName, text)
	local page = Pages[tabName]
	local Label = Instance.new("TextLabel")
	Label.Parent = page
	Label.Text = "--- [ " .. text .. " ] ---"
	Label.Font = Enum.Font.GothamBlack
	Label.TextSize = 14
	Label.TextColor3 = Colors.SectionText
	Label.Size = UDim2.new(1, -10, 0, 30)
	Label.BackgroundTransparency = 1
end

local function CreateToggle(tabName, text, settingKey)
	local page = Pages[tabName]
	local Frame = Instance.new("Frame")
	Frame.Parent = page
	Frame.BackgroundColor3 = Colors.ItemBG
	Frame.BackgroundTransparency = 0.5
	Frame.Size = UDim2.new(1, -10, 0, 40)
	Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 6)

	local Lbl = Instance.new("TextLabel")
	Lbl.Parent = Frame
	Lbl.Text = text
	Lbl.TextColor3 = Colors.Text
	Lbl.Font = Enum.Font.GothamSemibold
	Lbl.TextSize = 13
	Lbl.Size = UDim2.new(0.7, 0, 1, 0)
	Lbl.Position = UDim2.new(0, 15, 0, 0)
	Lbl.TextXAlignment = Enum.TextXAlignment.Left
	Lbl.BackgroundTransparency = 1

	local ToggleBtn = Instance.new("TextButton")
	ToggleBtn.Parent = Frame
	ToggleBtn.Position = UDim2.new(1, -50, 0.5, -10)
	ToggleBtn.Size = UDim2.new(0, 20, 0, 20)
	ToggleBtn.BackgroundColor3 = Colors.ToggleOff
	ToggleBtn.Text = ""
	Instance.new("UICorner", ToggleBtn).CornerRadius = UDim.new(0, 4)

	ToggleBtn.MouseButton1Click:Connect(function()
		_G.Settings[settingKey] = not _G.Settings[settingKey]
		ToggleBtn.BackgroundColor3 = _G.Settings[settingKey] and Colors.ToggleOn or Colors.ToggleOff
	end)
end

local function CreateStatusItem(tabName, labelText, getValueFunc)
	local page = Pages[tabName]
	local Frame = Instance.new("Frame")
	Frame.Parent = page
	Frame.BackgroundColor3 = Colors.ItemBG
	Frame.BackgroundTransparency = 0.5
	Frame.Size = UDim2.new(1, -10, 0, 35)
	Instance.new("UICorner", Frame).CornerRadius = UDim.new(0, 6)

	local Lbl = Instance.new("TextLabel")
	Lbl.Parent = Frame
	Lbl.Text = labelText
	Lbl.TextColor3 = Colors.Text
	Lbl.Font = Enum.Font.GothamSemibold
	Lbl.TextSize = 13
	Lbl.Size = UDim2.new(0.4, 0, 1, 0)
	Lbl.Position = UDim2.new(0, 15, 0, 0)
	Lbl.TextXAlignment = Enum.TextXAlignment.Left
	Lbl.BackgroundTransparency = 1

	local Val = Instance.new("TextLabel")
	Val.Parent = Frame
	Val.Text = "..."
	Val.TextColor3 = Colors.Accent
	Val.Font = Enum.Font.GothamBold
	Val.TextSize = 13
	Val.Size = UDim2.new(0.6, -15, 1, 0)
	Val.Position = UDim2.new(0.4, 0, 0, 0)
	Val.TextXAlignment = Enum.TextXAlignment.Right
	Val.BackgroundTransparency = 1

	spawn(function()
		while Frame.Parent do
			local s, r = pcall(getValueFunc)
			if s then Val.Text = tostring(r) else Val.Text = "N/A" end
			wait(1)
		end
	end)
end

-- --- NỘI DUNG TAB 1 & 2 ---

-- TAB 1: TRẠNG THÁI
CreateStatusItem("Trạng thái", "Tên :", function() return LocalPlayer.DisplayName end)
CreateStatusItem("Trạng thái", "Tộc :", function() return LocalPlayer.Data.Race.Value end)
CreateStatusItem("Trạng thái", "Beli :", function() return LocalPlayer.Data.Beli.Value end)
CreateStatusItem("Trạng thái", "Điểm F :", function() return LocalPlayer.Data.Fragments.Value end)
CreateStatusItem("Trạng thái", "Time :", function() 
	local t = workspace.DistributedGameTime
	return string.format("%02d:%02d:%02d", math.floor(t/3600), math.floor((t%3600)/60), math.floor(t%60))
end)

-- TAB 2: FAM
CreateSection("Fam", "CÀY CẤP CHUNG")
CreateToggle("Fam", "Auto Farm Level (All Sea)", "AutoFarmLevel")
CreateToggle("Fam", "Auto Farm Quái Gần", "AutoFarmNear")

CreateSection("Fam", "FAM XƯƠNG (HAUNTED CASTLE)")
CreateToggle("Fam", "Auto Fam Xương (20m Safe)", "AutoBone")
CreateToggle("Fam", "Auto Đổi Xương", "AutoTradeBone")
CreateToggle("Fam", "Auto Soul Reaper", "AutoSoulReaper")

-- --- [CORE ENGINE] LOGIC FARM ---

-- 1. Hàm Bay An Toàn (Lock Position)
local function LockPosition(targetCFrame)
	local char = LocalPlayer.Character
	if not char or not char:FindFirstChild("HumanoidRootPart") then return end
	local hrp = char.HumanoidRootPart
	
	-- Tính toán vị trí: Trên đầu quái 20m
	local targetPos = targetCFrame * CFrame.new(0, _G.Settings.Distance, 0)
	
	-- Cập nhật CFrame liên tục
	hrp.CFrame = targetPos
	
	-- BodyVelocity để chống trọng lực (Bay yên)
	if not hrp:FindFirstChild("AntiFall") then
		local bv = Instance.new("BodyVelocity")
		bv.Name = "AntiFall"
		bv.Parent = hrp
		bv.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
		bv.Velocity = Vector3.new(0, 0, 0)
	end
	
	-- Tắt va chạm
	for _, part in pairs(char:GetChildren()) do
		if part:IsA("BasePart") then part.CanCollide = false end
	end
end

local function UnlockPosition()
	local char = LocalPlayer.Character
	if char and char:FindFirstChild("HumanoidRootPart") and char.HumanoidRootPart:FindFirstChild("AntiFall") then
		char.HumanoidRootPart.AntiFall:Destroy()
	end
end

-- 2. Vòng lặp Farm Xương (Haunted Castle Only)
spawn(function()
	while true do
		RunService.RenderStepped:Wait()
		
		if _G.Settings.AutoBone then
			pcall(function()
				local MyRoot = LocalPlayer.Character.HumanoidRootPart
				local target = nil
				
				-- BƯỚC 1: TÌM QUÁI (Chỉ tìm quái thuộc danh sách Xương)
				for _, enemy in pairs(workspace.Enemies:GetChildren()) do
					if enemy:FindFirstChild("Humanoid") and enemy.Humanoid.Health > 0 and IsBoneMob(enemy.Name) then
						-- Tìm con gần nhất hoặc bất kỳ con nào còn sống
						target = enemy
						break 
					end
				end
				
				-- BƯỚC 2: DI CHUYỂN VÀ GOM QUÁI
				if target and target:FindFirstChild("HumanoidRootPart") then
					-- Bay yên vị trí cách 20m
					LockPosition(target.HumanoidRootPart.CFrame)
					
					-- Gom quái (Magnet) - Chỉ gom quái xương
					for _, subEnemy in pairs(workspace.Enemies:GetChildren()) do
						if subEnemy ~= target and IsBoneMob(subEnemy.Name) and subEnemy:FindFirstChild("HumanoidRootPart") then
							local dist = (subEnemy.HumanoidRootPart.Position - target.HumanoidRootPart.Position).Magnitude
							if dist < 300 then -- Chỉ gom trong phạm vi 300
								subEnemy.HumanoidRootPart.CFrame = target.HumanoidRootPart.CFrame
								subEnemy.HumanoidRootPart.CanCollide = false
								subEnemy.Humanoid.WalkSpeed = 0
							end
						end
					end
				else
					-- Nếu không tìm thấy quái (đã chết hết), tự động tìm bãi khác (thông qua vòng lặp tiếp theo)
					-- Hoặc nếu muốn chắc chắn, có thể thêm logic bay đến điểm spawn quái xương
				end
			end)
		elseif not _G.Settings.AutoFarmLevel and not _G.Settings.AutoFarmNear then
			UnlockPosition() -- Thả nhân vật ra khi tắt
		end
	end
end)

-- 3. Vòng lặp Đánh (Combat)
spawn(function()
	while true do
		wait()
		if _G.Settings.AutoBone or _G.Settings.AutoFarmLevel or _G.Settings.AutoFarmNear then
			pcall(function()
				VirtualUser:CaptureController()
				VirtualUser:Button1Down(Vector2.new(1280, 672))
			end)
		end
	end
end)

-- 4. Logic Đổi Xương (Auto Trade)
spawn(function()
	while true do
		wait(2)
		if _G.Settings.AutoTradeBone then
			pcall(function()
				game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer("Bones", "Buy", 1, 1)
			end)
		end
	end
end)
