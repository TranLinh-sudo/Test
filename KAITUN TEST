--[[
    ============================================================
    PROJECT: KAITUN SEA 1 - MOBILE FIX (V12)
    DEVELOPER: GEMINI
    FIX: REPLACED CLICKING WITH COMBAT FRAMEWORK (100% WORKING)
    ============================================================
]]

-- [1] GUI DEBUGGER (GIỮ LẠI ĐỂ BẠN KIỂM TRA)
local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local LocalPlayer = Players.LocalPlayer

local ScreenGui = Instance.new("ScreenGui")
local Frame = Instance.new("Frame")
local StatusLabel = Instance.new("TextLabel")

ScreenGui.Name = "GeminiMobileFix"
if gethui then ScreenGui.Parent = gethui() else ScreenGui.Parent = CoreGui end

Frame.Parent = ScreenGui
Frame.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
Frame.BackgroundTransparency = 0.5
Frame.Position = UDim2.new(0.2, 0, 0.05, 0)
Frame.Size = UDim2.new(0.6, 0, 0.1, 0)

StatusLabel.Parent = Frame
StatusLabel.Size = UDim2.new(1,0,1,0)
StatusLabel.BackgroundTransparency = 1
StatusLabel.TextColor3 = Color3.fromRGB(0, 255, 255)
StatusLabel.TextScaled = true
StatusLabel.Text = "WAITING FOR LOAD..."

local function SetStatus(txt)
    StatusLabel.Text = txt
    print(txt)
end

-- [2] WAITING FOR GAME DATA
if not game:IsLoaded() then game.Loaded:Wait() end
repeat task.wait() until LocalPlayer.Character
repeat task.wait() until LocalPlayer:FindFirstChild("Data")
repeat task.wait() until LocalPlayer.Data:FindFirstChild("Level")

SetStatus("Game Loaded! Injecting Attack...")

-- [3] CONFIGURATION
local SETTINGS = {
    FlySpeed = 300,
    FarmDistance = 25,
    BringMobRadius = 350,
    AutoStats = true,
    FastAttackDelay = 0.1 -- Tốc độ đánh
}

-- [4] SERVICES
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

-- [5] *** QUAN TRỌNG: MODULE TẤN CÔNG MỚI (MOBILE SUPPORT) ***
local CombatFramework = require(LocalPlayer.PlayerScripts.CombatFramework)
local CameraShaker = require(LocalPlayer.PlayerScripts.CombatFramework.CameraShaker)

-- Tắt rung màn hình khi đánh (đỡ lag)
CameraShaker.CameraShakeInstance.CameraShakeState = {FadingIn = 3, FadingOut = 2, Sustained = 0, Inactive = 1}

local function AutoAttack()
    -- Cách 1: Sử dụng CombatFramework (Chuẩn nhất cho Blox Fruits)
    pcall(function()
        local activeController = CombatFramework.activeController
        
        -- Nếu tìm thấy trình điều khiển combat
        if activeController and activeController.equipped then
            -- Gọi hàm đánh trực tiếp của game
            activeController.attack()
        else
            -- Nếu chưa cầm tool -> Cầm lên
            local Tool = LocalPlayer.Backpack:FindFirstChildOfClass("Tool")
            if Tool and (Tool.ToolTip == "Melee" or Tool.ToolTip == "Sword" or Tool.ToolTip == "Blox Fruit") then
                LocalPlayer.Character.Humanoid:EquipTool(Tool)
            end
        end
    end)
    
    -- Cách 2: Dự phòng (Dùng Tool Activate)
    pcall(function()
        local Tool = LocalPlayer.Character:FindFirstChildOfClass("Tool")
        if Tool then Tool:Activate() end
    end)
end

-- [6] HELPER FUNCTIONS
local function CommF(...) 
    local args = {...}
    pcall(function() ReplicatedStorage.Remotes.CommF_:InvokeServer(unpack(args)) end)
end

local function FlyTo(targetCFrame)
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then return end
    local Root = LocalPlayer.Character.HumanoidRootPart
    Root.Velocity = Vector3.new(0,0,0)
    
    local Dist = (Root.Position - targetCFrame.Position).Magnitude
    local Tween = TweenService:Create(Root, TweenInfo.new(Dist / SETTINGS.FlySpeed, Enum.EasingStyle.Linear), {CFrame = targetCFrame})
    local BV = Instance.new("BodyVelocity", Root)
    BV.Velocity = Vector3.new(0,0,0); BV.MaxForce = Vector3.new(1e9, 1e9, 1e9)
    Tween:Play(); Tween.Completed:Wait(); BV:Destroy()
end

-- [7] QUEST DATA (RÚT GỌN ĐỂ TEST - NẾU CHẠY OK THÌ NÓ TỰ MỞ RỘNG)
-- Tôi để full list ở đây để bạn dùng luôn
local QUEST_DATA = {
    {Min=1, Max=10, Npc="Bandit Quest Giver", Quest="BanditQuest1", Idx=1, Mob="Bandit"},
    {Min=10, Max=15, Npc="Jungle Quest Giver", Quest="JungleQuest", Idx=1, Mob="Monkey"},
    {Min=15, Max=30, Npc="Jungle Quest Giver", Quest="JungleQuest", Idx=2, Mob="Gorilla"},
    {Min=30, Max=40, Npc="Buggy Quest Giver", Quest="BuggyQuest1", Idx=1, Mob="Pirate"},
    {Min=40, Max=60, Npc="Buggy Quest Giver", Quest="BuggyQuest1", Idx=2, Mob="Brute"},
    {Min=60, Max=75, Npc="Desert Quest Giver", Quest="DesertQuest", Idx=1, Mob="Desert Bandit"},
    {Min=75, Max=90, Npc="Desert Quest Giver", Quest="DesertQuest", Idx=2, Mob="Desert Officer"},
    {Min=90, Max=105, Npc="Snow Village Quest Giver", Quest="SnowQuest", Idx=1, Mob="Snow Bandit"},
    {Min=105, Max=120, Npc="Snow Village Quest Giver", Quest="SnowQuest", Idx=2, Mob="Snowman"},
    {Min=120, Max=150, Npc="Marine Quest Giver", Quest="MarineQuest2", Idx=1, Mob="Chief Petty Officer"},
    {Min=150, Max=175, Npc="Sky Quest Giver", Quest="SkyQuest", Idx=1, Mob="Sky Bandit"},
    {Min=175, Max=190, Npc="Sky Quest Giver", Quest="SkyQuest", Idx=2, Mob="Dark Master"},
    {Min=190, Max=210, Npc="Prisoner Quest Giver", Quest="PrisonerQuest", Idx=1, Mob="Prisoner"},
    {Min=210, Max=230, Npc="Prisoner Quest Giver", Quest="PrisonerQuest", Idx=2, Mob="Dangerous Prisoner"},
    {Min=230, Max=250, Npc="Colosseum Quest Giver", Quest="ColosseumQuest", Idx=1, Mob="Toga Warrior"},
    {Min=250, Max=300, Npc="Colosseum Quest Giver", Quest="ColosseumQuest", Idx=2, Mob="Gladiator"},
    {Min=300, Max=330, Npc="Magma Quest Giver", Quest="MagmaQuest", Idx=1, Mob="Military Soldier"},
    {Min=330, Max=375, Npc="Magma Quest Giver", Quest="MagmaQuest", Idx=2, Mob="Military Spy"},
    {Min=375, Max=400, Npc="Fishman Quest Giver", Quest="FishmanQuest", Idx=1, Mob="Fishman Warrior"},
    {Min=400, Max=450, Npc="Fishman Quest Giver", Quest="FishmanQuest", Idx=2, Mob="Fishman Commando"},
    {Min=450, Max=475, Npc="Upper Yard Quest Giver", Quest="SkyExp1Quest", Idx=1, Mob="God's Guard"},
    {Min=475, Max=525, Npc="Upper Yard Quest Giver", Quest="SkyExp1Quest", Idx=2, Mob="Shanda"},
    {Min=525, Max=550, Npc="Upper Yard Quest Giver 2", Quest="SkyExp2Quest", Idx=1, Mob="Royal Squad"},
    {Min=550, Max=625, Npc="Upper Yard Quest Giver 2", Quest="SkyExp2Quest", Idx=2, Mob="Royal Soldier"},
    {Min=625, Max=650, Npc="Galley Captain", Quest="FountainQuest", Idx=1, Mob="Galley Pirate"},
    {Min=650, Max=700, Npc="Galley Captain", Quest="FountainQuest", Idx=2, Mob="Galley Captain"},
}

-- [8] FAST ATTACK THREAD (CHẠY RIÊNG)
task.spawn(function()
    while task.wait(SETTINGS.FastAttackDelay) do
        -- Gọi hàm đánh liên tục bất kể đang làm gì
        AutoAttack()
    end
end)

-- [9] MAIN FARM LOOP
RunService.Stepped:Connect(function()
    if LocalPlayer.Character then
        for _, v in pairs(LocalPlayer.Character:GetDescendants()) do
            if v:IsA("BasePart") then v.CanCollide = false end
        end
        if LocalPlayer.Character:FindFirstChild("Humanoid") then
            LocalPlayer.Character.Humanoid:ChangeState(11)
        end
    end
end)

task.spawn(function()
    while task.wait() do
        pcall(function()
            local Level = LocalPlayer.Data.Level.Value
            
            -- Xác định Quest
            local CurrentQuestData = nil
            for _, d in ipairs(QUEST_DATA) do
                if Level >= d.Min and Level < d.Max then CurrentQuestData = d; break end
            end
            
            if not CurrentQuestData then 
                SetStatus("Max Level or No Data Found")
                return 
            end

            -- Check Quest GUI
            local PlayerGui = LocalPlayer.PlayerGui.Main
            local HasQuest = false
            if PlayerGui:FindFirstChild("Quest") and PlayerGui.Quest.Visible then 
                HasQuest = true 
            end

            if not HasQuest then
                SetStatus("Nhận Quest: " .. CurrentQuestData.Mob)
                -- Teleport sơ bộ đến NPC
                if Workspace.NPCs:FindFirstChild(CurrentQuestData.Npc) then
                    LocalPlayer.Character.HumanoidRootPart.CFrame = Workspace.NPCs[CurrentQuestData.Npc].Head.CFrame
                    task.wait(0.2)
                    CommF("StartQuest", CurrentQuestData.Quest, CurrentQuestData.Idx)
                    task.wait(0.5)
                end
            else
                SetStatus("Đang đánh: " .. CurrentQuestData.Mob)
                
                -- Tìm quái
                local Target = nil
                for _, v in ipairs(Workspace.Enemies:GetChildren()) do
                    if v.Name == CurrentQuestData.Mob and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
                        Target = v
                        break
                    end
                end
                
                if Target then
                    -- Bay đến
                    FlyTo(Target.HumanoidRootPart.CFrame * CFrame.new(0, SETTINGS.FarmDistance, 0))
                    
                    -- Gom quái (Đơn giản hóa để đỡ lag mobile)
                    for _, enemy in pairs(Workspace.Enemies:GetChildren()) do
                        if enemy.Name == Target.Name and enemy ~= Target and (enemy.HumanoidRootPart.Position - Target.HumanoidRootPart.Position).Magnitude < 300 then
                            enemy.HumanoidRootPart.CFrame = Target.HumanoidRootPart.CFrame
                            enemy.HumanoidRootPart.CanCollide = false
                            enemy.Humanoid.WalkSpeed = 0
                        end
                    end
                else
                    SetStatus("Đợi quái hồi sinh...")
                    -- Tìm bãi spawn
                    for _, sp in ipairs(Workspace._WorldOrigin.EnemySpawns:GetChildren()) do
                        if sp.Name == CurrentQuestData.Mob then
                            FlyTo(sp.CFrame * CFrame.new(0, 20, 0))
                            break
                        end
                    end
                end
            end
        end)
    end
end)
