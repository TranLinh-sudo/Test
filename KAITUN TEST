--[[
    ============================================================
    PROJECT: KAITUN TITAN (SEA 1)
    TYPE: ADVANCED MOBILE AUTO FARM
    DEVELOPER: GEMINI
    BUILD: 2026.1.6
    ============================================================
]]

-- [1] SETTINGS & VARIABLES
getgenv().TitanSettings = {
    FlySpeed = 350,            -- Tốc độ bay (Nhanh hơn)
    FarmDistance = 15,         -- Đứng gần sát để đảm bảo trúng
    AutoStats = true,          -- Tự nâng chỉ số
    AutoHaki = true,           -- Tự bật Haki
    FastAttack = true,         -- Tự đánh nhanh
    WhiteScreen = false,       -- Bật màn hình trắng để giảm lag (False = Tắt)
    BringMobs = true           -- Gom quái
}

-- [2] GUI DEBUGGER (GIAO DIỆN TRẠNG THÁI)
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local CoreGui = game:GetService("CoreGui")

local ScreenGui = Instance.new("ScreenGui")
local MainFrame = Instance.new("Frame")
local Title = Instance.new("TextLabel")
local Status = Instance.new("TextLabel")
local ProgressBar = Instance.new("Frame")

ScreenGui.Name = "TitanInterface"
if gethui then ScreenGui.Parent = gethui() else ScreenGui.Parent = CoreGui end

MainFrame.Parent = ScreenGui
MainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
MainFrame.BorderSizePixel = 0
MainFrame.Position = UDim2.new(0.2, 0, 0.02, 0)
MainFrame.Size = UDim2.new(0.6, 0, 0.12, 0)

Title.Parent = MainFrame
Title.BackgroundTransparency = 1
Title.Size = UDim2.new(1, 0, 0.4, 0)
Title.Font = Enum.Font.GothamBlack
Title.Text = "⚡ KAITUN TITAN ⚡"
Title.TextColor3 = Color3.fromRGB(255, 215, 0)
Title.TextSize = 16

Status.Parent = MainFrame
Status.BackgroundTransparency = 1
Status.Position = UDim2.new(0, 0, 0.4, 0)
Status.Size = UDim2.new(1, 0, 0.4, 0)
Status.Font = Enum.Font.GothamBold
Status.TextColor3 = Color3.fromRGB(0, 255, 255)
Status.TextSize = 14
Status.Text = "Initializing..."

ProgressBar.Parent = MainFrame
ProgressBar.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
ProgressBar.BorderSizePixel = 0
ProgressBar.Position = UDim2.new(0, 0, 0.9, 0)
ProgressBar.Size = UDim2.new(0, 0, 0.1, 0) -- Sẽ chạy animation

local function SetStatus(msg)
    Status.Text = msg
    -- Hiệu ứng thanh chạy
    ProgressBar:TweenSize(UDim2.new(math.random(3,10)/10, 0, 0.1, 0), "Out", "Quad", 0.2)
end

-- [3] SERVICES LOAD
SetStatus("Loading Services...")
if not game:IsLoaded() then game.Loaded:Wait() end
local Workspace = game:GetService("Workspace")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local VirtualInputManager = game:GetService("VirtualInputManager")

-- [4] WAITING FOR DATA
while not LocalPlayer:FindFirstChild("Data") or not LocalPlayer.Data:FindFirstChild("Level") do
    SetStatus("Waiting for Data...")
    task.wait(1)
end
SetStatus("Data Loaded! Start Farming...")

-- [5] CORE ENGINE (HỆ THỐNG CỐT LÕI)

-- >> SYSTEM 1: MOVEMENT (DI CHUYỂN)
local function GetDistance(targetPos)
    if not LocalPlayer.Character then return 99999 end
    return (LocalPlayer.Character.HumanoidRootPart.Position - targetPos).Magnitude
end

local function FlyTo(targetCFrame)
    if not LocalPlayer.Character or not LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then return end
    local Root = LocalPlayer.Character.HumanoidRootPart
    
    -- Anti Gravity
    if not Root:FindFirstChild("TitanFlight") then
        local BV = Instance.new("BodyVelocity", Root)
        BV.Name = "TitanFlight"
        BV.MaxForce = Vector3.new(1e9, 1e9, 1e9)
        BV.Velocity = Vector3.new(0,0,0)
    end
    
    local Dist = (Root.Position - targetCFrame.Position).Magnitude
    
    -- Nếu gần thì teleport luôn cho nhanh
    if Dist < 100 then
        Root.CFrame = targetCFrame
        return
    end

    -- Tính toán Tween
    local Speed = TitanSettings.FlySpeed
    local Time = Dist / Speed
    local TInfo = TweenInfo.new(Time, Enum.EasingStyle.Linear)
    local Tween = TweenService:Create(Root, TInfo, {CFrame = targetCFrame})
    
    Tween:Play()
    
    -- Vòng lặp kiểm tra (để có thể hủy bay nếu cần)
    local Start = tick()
    while (tick() - Start) < Time do
        if not LocalPlayer.Character or LocalPlayer.Character.Humanoid.Health <= 0 then 
            Tween:Cancel()
            break 
        end
        -- Nếu đã đến rất gần
        if (Root.Position - targetCFrame.Position).Magnitude < 10 then
            break
        end
        RunService.Stepped:Wait()
    end
    
    -- Dọn dẹp
    if Root:FindFirstChild("TitanFlight") then
        Root.CFrame = targetCFrame -- Chốt vị trí cuối
        -- Giữ BodyVelocity để treo trên không, không xóa ngay
        Root.TitanFlight.Velocity = Vector3.new(0,0,0)
    end
end

-- >> SYSTEM 2: ATTACK ENGINE (MOBILE OPTIMIZED)
-- Đây là phần quan trọng nhất: Dùng Tool Activate + Face Target
local function EquipWeapon()
    pcall(function()
        local Backpack = LocalPlayer.Backpack
        local Char = LocalPlayer.Character
        -- Ưu tiên Melee (Võ) hoặc Sword (Kiếm)
        local Weapon = Char:FindFirstChildOfClass("Tool")
        if not Weapon then
            for _, v in pairs(Backpack:GetChildren()) do
                if v:IsA("Tool") and (v.ToolTip == "Melee" or v.ToolTip == "Sword") then
                    Char.Humanoid:EquipTool(v)
                    break
                end
            end
        end
    end)
end

local function AttackMob(TargetInstance)
    if not TargetInstance or not LocalPlayer.Character then return end
    
    -- 1. Cầm vũ khí
    EquipWeapon()
    
    -- 2. Hướng mặt về phía quái (Bắt buộc để đánh trúng)
    local Root = LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
    local TargetRoot = TargetInstance:FindFirstChild("HumanoidRootPart")
    
    if Root and TargetRoot then
        Root.CFrame = CFrame.lookAt(Root.Position, TargetRoot.Position)
    end
    
    -- 3. Kích hoạt đòn đánh (Spam Click)
    local Tool = LocalPlayer.Character:FindFirstChildOfClass("Tool")
    if Tool then
        -- Cách 1: Activate chuẩn
        Tool:Activate()
        
        -- Cách 2: VirtualInput (Backup)
        pcall(function()
            VirtualInputManager:SendMouseButtonEvent(0, 0, 0, true, game, 1)
            VirtualInputManager:SendMouseButtonEvent(0, 0, 0, false, game, 1)
        end)
    end
    
    -- 4. Auto Haki
    if TitanSettings.AutoHaki and not LocalPlayer.Character:FindFirstChild("HasBuso") then
        local HakiRemote = ReplicatedStorage.Remotes:FindFirstChild("CommF_")
        if HakiRemote then HakiRemote:InvokeServer("Buso") end
    end
end

-- >> SYSTEM 3: QUEST MANAGER (FULL DATA)
local QUESTS = {
    {Min=1, Max=10, Npc="Bandit Quest Giver", Quest="BanditQuest1", Idx=1, Mob="Bandit"},
    {Min=10, Max=15, Npc="Jungle Quest Giver", Quest="JungleQuest", Idx=1, Mob="Monkey"},
    {Min=15, Max=30, Npc="Jungle Quest Giver", Quest="JungleQuest", Idx=2, Mob="Gorilla"},
    {Min=30, Max=40, Npc="Buggy Quest Giver", Quest="BuggyQuest1", Idx=1, Mob="Pirate"},
    {Min=40, Max=60, Npc="Buggy Quest Giver", Quest="BuggyQuest1", Idx=2, Mob="Brute"},
    {Min=60, Max=75, Npc="Desert Quest Giver", Quest="DesertQuest", Idx=1, Mob="Desert Bandit"},
    {Min=75, Max=90, Npc="Desert Quest Giver", Quest="DesertQuest", Idx=2, Mob="Desert Officer"},
    {Min=90, Max=105, Npc="Snow Village Quest Giver", Quest="SnowQuest", Idx=1, Mob="Snow Bandit"},
    {Min=105, Max=120, Npc="Snow Village Quest Giver", Quest="SnowQuest", Idx=2, Mob="Snowman"},
    {Min=120, Max=150, Npc="Marine Quest Giver", Quest="MarineQuest2", Idx=1, Mob="Chief Petty Officer"},
    {Min=150, Max=175, Npc="Sky Quest Giver", Quest="SkyQuest", Idx=1, Mob="Sky Bandit"},
    {Min=175, Max=190, Npc="Sky Quest Giver", Quest="SkyQuest", Idx=2, Mob="Dark Master"},
    {Min=190, Max=210, Npc="Prisoner Quest Giver", Quest="PrisonerQuest", Idx=1, Mob="Prisoner"},
    {Min=210, Max=230, Npc="Prisoner Quest Giver", Quest="PrisonerQuest", Idx=2, Mob="Dangerous Prisoner"},
    {Min=230, Max=250, Npc="Colosseum Quest Giver", Quest="ColosseumQuest", Idx=1, Mob="Toga Warrior"},
    {Min=250, Max=300, Npc="Colosseum Quest Giver", Quest="ColosseumQuest", Idx=2, Mob="Gladiator"},
    {Min=300, Max=330, Npc="Magma Quest Giver", Quest="MagmaQuest", Idx=1, Mob="Military Soldier"},
    {Min=330, Max=375, Npc="Magma Quest Giver", Quest="MagmaQuest", Idx=2, Mob="Military Spy"},
    {Min=375, Max=400, Npc="Fishman Quest Giver", Quest="FishmanQuest", Idx=1, Mob="Fishman Warrior"},
    {Min=400, Max=450, Npc="Fishman Quest Giver", Quest="FishmanQuest", Idx=2, Mob="Fishman Commando"},
    {Min=450, Max=475, Npc="Upper Yard Quest Giver", Quest="SkyExp1Quest", Idx=1, Mob="God's Guard"},
    {Min=475, Max=525, Npc="Upper Yard Quest Giver", Quest="SkyExp1Quest", Idx=2, Mob="Shanda"},
    {Min=525, Max=550, Npc="Upper Yard Quest Giver 2", Quest="SkyExp2Quest", Idx=1, Mob="Royal Squad"},
    {Min=550, Max=625, Npc="Upper Yard Quest Giver 2", Quest="SkyExp2Quest", Idx=2, Mob="Royal Soldier"},
    {Min=625, Max=650, Npc="Galley Captain", Quest="FountainQuest", Idx=1, Mob="Galley Pirate"},
    {Min=650, Max=700, Npc="Galley Captain", Quest="FountainQuest", Idx=2, Mob="Galley Captain"},
}

-- [6] MAIN LOOP (LOGIC THÔNG MINH)
task.spawn(function()
    while task.wait() do
        pcall(function()
            -- A. Auto Stats
            if TitanSettings.AutoStats then
                local Pts = LocalPlayer.Data.Points.Value
                if Pts > 0 then
                    local Melee = math.floor(Pts * 0.7) -- 70% Melee
                    local Def = Pts - Melee
                    ReplicatedStorage.Remotes.CommF_:InvokeServer("AddPoint", "Melee", Melee)
                    ReplicatedStorage.Remotes.CommF_:InvokeServer("AddPoint", "Defense", Def)
                end
            end

            -- B. Farm Logic
            local Level = LocalPlayer.Data.Level.Value
            
            -- Xác định Quest phù hợp
            local CurrentQuestData = nil
            for _, q in ipairs(QUESTS) do
                if Level >= q.Min and Level < q.Max then CurrentQuestData = q; break end
            end
            
            if not CurrentQuestData then SetStatus("Max Level Reached!"); return end
            
            -- Kiểm tra xem đã nhận Quest chưa
            local HasQuest = false
            local PlayerGui = LocalPlayer.PlayerGui.Main
            if PlayerGui:FindFirstChild("Quest") and PlayerGui.Quest.Visible then 
                HasQuest = true 
            end
            
            if not HasQuest then
                -- >> GIAI ĐOẠN 1: ĐI NHẬN QUEST
                SetStatus("Nhận Quest: " .. CurrentQuestData.Mob)
                
                -- Tìm NPC
                local NPC = Workspace.NPCs:FindFirstChild(CurrentQuestData.Npc)
                if NPC then
                    -- Bay đến NPC
                    FlyTo(NPC.Head.CFrame)
                    -- Nhận Quest
                    ReplicatedStorage.Remotes.CommF_:InvokeServer("StartQuest", CurrentQuestData.Quest, CurrentQuestData.Idx)
                else
                    -- FIX LỖI KHÔNG TÌM THẤY ĐẢO: Bay đến bãi quái để load map
                    SetStatus("Tìm Đảo: " .. CurrentQuestData.Mob)
                    local Spawns = Workspace._WorldOrigin.EnemySpawns:FindFirstChild(CurrentQuestData.Mob)
                    if Spawns then
                        FlyTo(Spawns.CFrame * CFrame.new(0, 60, 0)) -- Bay cao để nhìn bao quát
                    end
                end
            else
                -- >> GIAI ĐOẠN 2: ĐI FARM
                SetStatus("Tiêu diệt: " .. CurrentQuestData.Mob)
                
                local Target = nil
                -- Tìm quái gần nhất
                for _, v in pairs(Workspace.Enemies:GetChildren()) do
                    if v.Name == CurrentQuestData.Mob and v:FindFirstChild("Humanoid") and v.Humanoid.Health > 0 then
                        Target = v
                        break -- Lấy con đầu tiên thấy
                    end
                end
                
                if Target then
                    -- Bay đến quái
                    local FarmPos = Target.HumanoidRootPart.CFrame * CFrame.new(0, 0, TitanSettings.FarmDistance)
                    -- Đảo ngược CFrame để mặt đối mặt với quái
                    FarmPos = CFrame.lookAt(FarmPos.Position, Target.HumanoidRootPart.Position)
                    
                    FlyTo(FarmPos)
                    AttackMob(Target)
                    
                    -- Gom quái (Nam châm)
                    if TitanSettings.BringMobs then
                        for _, enemy in pairs(Workspace.Enemies:GetChildren()) do
                            if enemy.Name == Target.Name and enemy ~= Target then
                                if (enemy.HumanoidRootPart.Position - Target.HumanoidRootPart.Position).Magnitude < 300 then
                                    enemy.HumanoidRootPart.CFrame = Target.HumanoidRootPart.CFrame
                                    enemy.HumanoidRootPart.CanCollide = false
                                    enemy.Humanoid.WalkSpeed = 0
                                    enemy.Head.CanCollide = false
                                end
                            end
                        end
                    end
                else
                    -- Không thấy quái -> Bay đến chỗ Spawn đợi
                    SetStatus("Chờ quái hồi sinh...")
                    local Spawns = Workspace._WorldOrigin.EnemySpawns:FindFirstChild(CurrentQuestData.Mob)
                    if Spawns then
                        FlyTo(Spawns.CFrame * CFrame.new(0, 30, 0))
                    end
                end
            end
        end)
    end
end)

-- [7] UTILITIES (TIỆN ÍCH)
-- Tự động bật lại khi chết
LocalPlayer.CharacterAdded:Connect(function()
    task.wait(1)
end)

-- Noclip (Đi xuyên tường)
RunService.Stepped:Connect(function()
    if LocalPlayer.Character then
        for _, v in pairs(LocalPlayer.Character:GetDescendants()) do
            if v:IsA("BasePart") then v.CanCollide = false end
        end
    end
end)
